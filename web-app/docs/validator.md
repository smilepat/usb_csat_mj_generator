# Validation 시스템 가이드

수능 문항 생성 시스템의 품질 검증 체계를 설명합니다.

---

## 1. Prompt Validation (프롬프트 품질 검증)

LLM 호출 전에 프롬프트 구조 및 내용을 자동 검증하는 체크리스트 기반 시스템입니다.

### 1.1 관련 파일

- **주요 파일**: `server/services/promptValidator.js`
- **함수**: `validatePromptQuality()`, `validatePromptStructure()`, `validatePromptBundle()`

### 1.2 검증 항목 (4개 카테고리)

| 카테고리 | 코드 | 항목 | 검증 기준 | 가중치 |
|---------|------|------|----------|--------|
| **A. 기본 구조** | A1 | MASTER_PROMPT 참조 | 시스템이 자동 병합 (정보성) | 1.0 |
| | A3 | 출력 포맷 명시 | passage, question, options, answer, explanation 필드 | 1.0 |
| | A4 | 선택지 5개 고정 | "5개", "five", "5 options" 등 명시 | 1.0 |
| | A5 | LC 스크립트 필드 | LC 문항(1-17): lc_script/스크립트/대본 | 1.0 |
| | A6 | RC29 grammar_meta | RC29(어법) 문항: 문법 오류 유형 명시 | 1.0 |
| **B. 문항 필수 선언** | B1 | 수능 유형 명시 | "수능 X번", "RC X", "문항 번호: X" | 1.5 |
| | B2 | 사고 유형 선언 | 목적 파악, 심경 변화, 빈칸 추론 등 | 1.5 |
| | B3 | 난이도 목표 | "중위권", "상위권", "하/중하/중/중상/상" | 1.5 |
| **C. 오답 설계** | C1 | 오답 설계 지침 | "오답", "distractor", "매력적", "변별" 키워드 | 2.0 |
| | C2 | 변별력 지침 | "변별력", "정답은 가장 늦게", "매력적인 오답" | 2.0 |
| **D. 금지 패턴** | D1 | 단문 프롬프트 차단 | 최소 200자 이상 | 0.8 |
| | D3 | 사고 유형 명확성 | "적절한 것", "괜찮은" 같은 모호한 표현 제거 | 0.8 |

### 1.3 필수 키워드

**출력 포맷 필드 키워드**:
- passage: `"passage"`, `"stimulus"`, `"지문"`
- question: `"question"`, `"stem"`, `"발문"`
- options: `"options"`, `"choices"`, `"선택지"`
- answer: `"answer"`, `"correct_answer"`, `"정답"`
- explanation: `"explanation"`, `"rationale"`, `"해설"`

**오답 설계 키워드 (C1)**:
- `"오답"`, `"distractor"`, `"매력적"`, `"선택지"`, `"변별"`, `"난이도"`, `"함정"`
- `"부분 일치"`, `"과잉 일반화"`, `"반대 의미"`, `"무관한"`

**변별력 키워드 (C2)**:
- `"변별력"`, `"변별"`, `"정답률"`, `"가장 늦게"`, `"매력적인 오답"`

### 1.4 점수 계산

```
점수 = (통과 항목 × 가중치 합) / (전체 항목 × 가중치 합) × 100
```

**통과 조건**: 모든 Error = 0개

---

## 2. Item Validation (생성된 문항 품질 검증)

생성된 문항의 품질을 **3겹 검증 시스템**으로 평가합니다.

### 2.1 3겹 검증 시스템 구조

```
┌─────────────────────────────────────────────┐
│ Layer 1: 구조 검증 (40%)                     │
│ - 기본 필드 존재 여부                         │
│ - Pass/Fail 이진 판정                        │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│ Layer 3: 수능 적합성 (35%)                   │
│ - 지문 길이, 문장 복잡도, 선택지 형식          │
│ - 규칙 기반 (LLM 미사용)                     │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│ Layer 2: 내용 품질 (25%)                     │
│ - 규칙 기반 + LLM 기반                       │
│ - 정답 적합성, 오답 설계, 변별력              │
└─────────────────────────────────────────────┘
                    ↓
              최종 점수 계산
              등급/분류 결정
```

### 2.2 Layer 1: 구조 검증

**파일**: `server/services/validators/common.js`

| 필드 | 검증 기준 | 결과 |
|------|----------|------|
| question | 비어있지 않음 | FAIL if empty |
| options | 배열이고 5개 | FAIL if != 5 |
| answer | 1-5 범위 | FAIL if out of range |
| passage | 권장 (경고만) | WARNING if empty |
| explanation | 권장 (경고만) | WARNING if empty |

**점수**: 통과 시 100점, 실패 시 0점

### 2.3 Layer 3: 수능 적합성 검증

**파일**: `server/services/metricsService.js` (calculateLayer3Metrics)

| 항목 | 배점 | 평가 기준 |
|------|------|----------|
| 지문 길이 | 40점 | 문항별 표준 단어 수 범위 내 |
| 문장 복잡도 | 30점 | 평균 문장 길이 12-28단어 |
| 선택지 형식 | 30점 | 5개 모두 채워짐, 중복 없음 |

**문항번호별 지문 길이 기준**:

| 문항 번호 | 최소 | 최대 | 권장 | 비고 |
|----------|------|------|------|------|
| 1-17 (LC) | 50 | 150 | 100 | 듣기 |
| 18-24 | 100 | 200 | 150 | RC 일반 |
| 25 | 80 | 150 | 100 | 도표 |
| 27 | 80 | 150 | 100 | 안내문 |
| 31-32 | 130 | 250 | 180 | 빈칸 |
| 33-34 | 150 | 280 | 200 | 빈칸 (고난도) |
| 35-39 | 130 | 250 | 180 | 논리 |
| 40 | 150 | 280 | 200 | 요약 |
| 41-42 | 200 | 400 | 300 | 장문 세트 |
| 43-45 | 250 | 450 | 350 | 장문 세트 |

### 2.4 Layer 2: 내용 품질 검증

#### 2.4.1 규칙 기반 검증

**파일**: `server/services/metricsService.js` (calculateLayer2RuleMetrics)

| 항목 | 배점 | 검증 기준 |
|------|------|----------|
| 정답 범위 | 30점 | 1-5 범위 내 |
| 선택지 중복 | 40점 | 중복 없는 선택지 |
| 해설 존재 | 30점 | 10자 이상의 해설 |

#### 2.4.2 LLM 기반 상세 평가

**파일**: `server/services/itemEvaluator.js`

| 항목 | 배점 | 평가 기준 |
|------|------|----------|
| **A. 정답 적합성** | 30점 | 지문 논지 일치, 패러프레이즈 (베끼기 X) |
| **B. 오답 설계** | 25점 | 4가지 오류 유형 다양성 |
| **C. 변별력** | 20점 | 정답이 "가장 늦게 탈락", 복수정답 위험 |
| **D. 유형 적합성** | 15점 | 문항 특성별 검사 |
| **E. 자연스러움** | 10점 | 수능 영어 스타일 |

**오답 오류 유형 (4가지)**:
1. **지엽정보**: 세부 사항에만 해당
2. **과잉해석**: 지문 내용을 과도하게 확대 해석
3. **반대방향**: 지문 논지와 반대
4. **무관정보**: 지문과 관련 없는 내용

### 2.5 사전 검증 (quickItemCheck)

LLM 평가 전 규칙 기반으로 빠르게 검사합니다.

| 검사 항목 | 기준 | 처리 |
|----------|------|------|
| 정답 지문 복사 | 20자 이상 그대로 일치 | ISSUE (재생성) |
| 선택지 길이 극단차 | 정답이 2배 이상 길거나 짧음 | WARNING |
| 선택지 중복 | 동일한 선택지 | ISSUE |
| 해설 모순 | 다른 번호가 정답으로 표기 | ISSUE |
| RC29 문법 | grammar_meta 필드 존재 | WARNING |
| RC31-34 빈칸 | 빈칸 표시(___) 존재 | WARNING |

### 2.6 재생성 트리거

다음 조건 발생 시 문항을 자동 재생성합니다:

| 트리거 | 조건 |
|--------|------|
| multiple_correct_answers | 정답 후보 2개 이상 |
| weak_distractors | 오답이 너무 약함 |
| answer_copies_passage | 정답이 지문 그대로 복사 |
| too_easy | 점수 < 70 && too_easy 플래그 |
| type_mismatch | 문항 유형 불일치 |
| distractor_types_not_diverse | 오답 유형 다양성 부족 |

---

## 3. 최종 점수 계산

### 3.1 가중치 적용

```javascript
finalScore = Layer1(40%) + Layer3(35%) + Layer2(25%)

// Layer 1 미통과 시 패널티
if (!layer1.pass) {
  finalScore = min(40, layer3 × 0.3 + layer2 × 0.1)
}
```

### 3.2 등급 기준

| 등급 | 점수 범위 |
|------|----------|
| A | 90점 이상 |
| B | 80-89점 |
| C | 70-79점 |
| D | 60-69점 |
| F | 60점 미만 |

### 3.3 분류 기준

| 분류 | 점수 범위 | 의미 |
|------|----------|------|
| APPROVE | 85점 이상 | 승인 |
| REVIEW | 65-84점 | 검토 필요 |
| REJECT | 65점 미만 | 재생성 필요 |

---

## 4. 형식 검증 (format.js)

**파일**: `server/services/validators/format.js`

### 4.1 검증 항목

| 항목 | 검증 기준 | 결과 |
|------|----------|------|
| 언어 혼합 | 지문 영어 + 선택지 한국어 | WARNING |
| 지문 길이 | 문항별 권장 범위 | WARNING/ERROR |
| 선택지 길이 | 너무 짧음 (1단어) | WARNING |
| 정답-지문 중복 | 100% 일치 시 | WARNING (패러프레이즈 필요) |
| 노골적 오답 | 지문과 무관해 쉽게 제거됨 | WARNING |

---

## 5. 유형별 검증

### 5.1 validators 폴더 구조

| 파일 | 담당 | 검증 내용 |
|------|------|----------|
| `common.js` | 모든 문항 | question, options, answer, passage, explanation |
| `constants.js` | 전역 상수 | ITEM_NUMBER_RANGES, WORD_COUNT_RANGES |
| `format.js` | 형식 검증 | 언어 혼합, 길이, 금지 패턴 |
| `grammar.js` | RC29 | 밑줄 형식, 개수 (5개) |
| `gap.js` | RC31-34 | 빈칸 개수, 형식 |
| `chart.js` | RC25 | 도표 데이터 |
| `listening.js` | LC1-17 | 대화 구조, 선택지 언어 |
| `set.js` | 세트 문항 | 16-17, 41-42, 43-45 패턴 |

### 5.2 세트 문항 검증 (set.js)

| 세트 | 문항 범위 | 검증 내용 |
|------|----------|----------|
| LC 세트 | 16-17 | 2문항 모두 존재 |
| RC 세트 | 41-42 | 2문항 모두 존재 |
| RC 세트 | 43-45 | 3문항 모두 존재 |

---

## 6. 워크플로우 요약

```
프롬프트 입력
    ↓
[promptValidator.js]
  ├─ validatePromptStructure()
  ├─ validatePromptQuality() ← 체크리스트 (A/B/C/D)
  └─ 결과: pass/fail + 점수
    ↓
프롬프트 통과 시 → LLM 호출 → 문항 생성
    ↓
[itemEvaluator.js]
  ├─ quickItemCheck() ← 규칙 기반 사전 검증
  ├─ 심각한 오류 → REJECT
  └─ 통과 → evaluateItem() (LLM 평가)
    ↓
[metricsService.js]
  ├─ Layer 1: calculateLayer1Metrics()
  ├─ Layer 3: calculateLayer3Metrics()
  ├─ Layer 2: calculateLayer2RuleMetrics() + LLM
  └─ calculateFinalMetrics() → 최종 점수/등급/분류
    ↓
결과: APPROVE / REVIEW / REJECT
```

---

## 7. 참고: 문항 번호별 사고 유형

| 번호 | 유형 | 키워드 |
|------|------|--------|
| 1-2 | 대화 응답 | dialogue, response |
| 3-6 | 목적/의견/주장 | purpose, opinion |
| 18 | 글의 목적 | purpose, 목적 |
| 19 | 심경 변화 | feeling, mood, 심경 |
| 20 | 필자 주장 | claim, 주장 |
| 21 | 함축 의미 | imply, 함축 |
| 22 | 글의 요지 | main point, 요지 |
| 23 | 글의 주제 | topic, 주제 |
| 24 | 제목 추론 | title, 제목 |
| 25 | 도표 이해 | chart, graph, 도표 |
| 29 | 어법 판단 | grammar, 어법 |
| 31-34 | 빈칸 추론 | blank, gap, 빈칸 |
| 35 | 무관한 문장 | irrelevant, 무관 |
| 36-37 | 글의 순서 | order, 순서 |
| 38-39 | 문장 삽입 | insert, 삽입 |
| 40 | 요약문 완성 | summary, 요약 |
| 41-42 | 장문 (제목+순서) | long passage, 장문 |
| 43-45 | 장문 (순서+삽입+일치) | long passage, 세트 |
